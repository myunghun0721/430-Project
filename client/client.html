<!DOCTYPE html>
<html lang="en">
<head>
  <title>When to play?</title>
  <link rel="stylesheet" type="text/css" href="/style.css">
  
  <script>
    const handleResponse = (xhr, parseResponse) => {
      const content = document.querySelector('#content');
      
      switch(xhr.status){
        case 200:
          content.innerHTML = '<b>Success!</b>'
          break;
        case 201:
          content.innerHTML = '<b>Created!</b>'
          break;
        case 204:
          content.innerHTML = '<b>Updated (No Content)!</b>'
          break;
        case 400:
          content.innerHTML = '<b>Bad Request!</b>'
          break;
        default:
          content.innerHTML = '<b>Resource Not Found</b>'
          break;
      }
      parseJSON(xhr, content);
    };

    const parseJSON = (xhr, content) => {
      if(xhr.response && xhr.getResponseHeader('Content-Type') === 'application/json'){
        const obj = JSON.parse(xhr.response);
        //console.log(obj.games);

        if(obj.message){
          content.innerHTML += `<p>${obj.message}</p>`;
        }
        else{
          content.innerHTML += `<p>${xhr.response}</p>`;
        }

        let gameType = obj.games;
        if(gameType){
          if(gameType.Among_us){
            console.log(gameType.Among_us.name);
            console.log(gameType.Among_us.date);
            console.log(gameType.Among_us.time);
          }
          if(gameType.League_of_legends){
            console.log(gameType.League_of_legends.name);
            console.log(gameType.League_of_legends.date);
            console.log(gameType.League_of_legends.time);
          }
          if(gameType.Teamfight_tactics){
            console.log(gameType.Teamfight_tactics.name);
            console.log(gameType.Teamfight_tactics.date);
            console.log(gameType.Teamfight_tactics.time);
          }
          if(gameType.Fall_guys){
            console.log(gameType.Fall_guys.name);
            console.log(gameType.Fall_guys.date);
            console.log(gameType.Fall_guys.time);
          }
          if(gameType.Overwatch){
            console.log(gameType.Overwatch.name);
            console.log(gameType.Overwatch.date);
            console.log(gameType.Overwatch.time);
          }
          if(gameType.Starcraft){
            console.log(gameType.Starcraft.name);
            console.log(gameType.Starcraft.date);
            console.log(gameType.Starcraft.time);
          }
        }
      }
    };



    const sendPost = (e, schedule) => {
      e.preventDefault();

      const nameAction = schedule.getAttribute('action');
      const nameMethod = schedule.getAttribute('method');

      const nameField = schedule.querySelector('#nameField');
      const dateField = schedule.querySelector('#dateField');
      const timeField = schedule.querySelector('#timeField');

      const xhr = new XMLHttpRequest();
      xhr.open(nameMethod, nameAction);

      xhr.setRequestHeader('Accept', 'application/json');
      xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

      xhr.onload = () => handleResponse(xhr);
      const formData = `name=${nameField.value}&date=${dateField.value}&time=${timeField.value}`;
      xhr.send(formData);

      return false;
    };

    const requestUpdate = (e, userForm) => {
      const url = userForm.querySelector('#urlField').value;
      const method = userForm.querySelector('#methodSelect').value;
      
      const xhr = new XMLHttpRequest();
      xhr.open(method, url);

      xhr.setRequestHeader('Accept', 'application/json');

      if(method === 'get'){
        xhr.onload = () => handleResponse(xhr, true);
      } else{
        xhr.onload = () => handleResponse(xhr, false);
      }

      xhr.send();

      e.preventDefault();
      return false;
    };
    
    const init = () => {
      //name form
      const schedule = document.querySelector('#schedule'); 
      const addGame = (e) => sendPost(e, schedule);  
      schedule.addEventListener('submit', addGame);

      //user form
      const userForm = document.querySelector('#userForm');     
      const getGames = (e) => requestUpdate(e, userForm); 
      userForm.addEventListener('submit', getGames);
    };

    window.onload = init;

  </script>
</head>
<body>
  <section id="top">
    <h3>POST Status Code Tests</h3>
    <form id="schedule" action="/addGame" method="post">
      <label for="name">Game name: </label>
      <select id="nameField" type="text" name="name">
        <option value="Among_us">Among us</option>
        <option value="League_of_legends">League of legends</option>
        <option value="Teamfight_tactics">Teamfight tactics</option>
        <option value="Fall_guys">Fall guys</option>
        <option value="Overwatch">Overwatch</option>
        <option value="Starcraft">Starcraft</option>
      </select>
      <label for="date">Date: </label>
      <input id="dateField" type="date" name="date" value="2020-09-27" min="2020-01-01" max="2100-12-31">
      <label for="time">Set time: </label>
      <input id="timeField" type="time" name="appt" required>
      <input type="submit" value="Post Game" />
    </form>
    <hr>
    <form id="userForm" action="/getGames" method="get">
      <select id='urlField'>
        <option value='/getGames'>/getGames</option>
        <option value='/notReal'>/notReal</option>
      </select>
      <select id="methodSelect">
        <option value="get">GET</option>
        <option value="head">HEAD</option>
      </select>
      <input type="submit" value="Send" />
    </form>
  </section>
  <section id="content">
  </section>
</body>
</html>
